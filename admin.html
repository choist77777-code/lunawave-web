<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" href="/favicon-32.png" type="image/png" sizes="32x32">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LunaWave Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="/js/supabase-client.js"></script>
<style>
:root {
    --bg: #0f0f14; --bg2: #16161e; --bg3: #1e1e28; --bg4: #282834;
    --gold: #f5a623; --gold2: #e8941a; --gold-dim: rgba(245,166,35,.12);
    --text: #e8e8f0; --text2: #9999b3; --text3: #64648c;
    --green: #22c55e; --red: #ef4444; --blue: #3b82f6;
    --line: #2a2a3a; --radius: 10px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Noto Sans KR','Outfit',sans-serif; background:var(--bg); color:var(--text); display:flex; min-height:100vh; }

/* SIDEBAR */
.sidebar { width:220px; background:var(--bg2); border-right:1px solid var(--line); padding:20px 0; position:fixed; top:0; left:0; bottom:0; display:flex; flex-direction:column; z-index:100; }
.sidebar-logo { display:flex; align-items:center; gap:10px; padding:0 20px 24px; border-bottom:1px solid var(--line); margin-bottom:12px; }
.sidebar-logo svg { flex-shrink:0; }
.sidebar-logo-text { font-family:'Outfit'; font-weight:700; font-size:18px; letter-spacing:1px; }
.sidebar-logo-text span { font-weight:300; color:var(--text3); }
.nav-item { display:flex; align-items:center; gap:10px; padding:10px 20px; font-size:13px; color:var(--text2); cursor:pointer; transition:all .15s; border-left:3px solid transparent; }
.nav-item:hover { color:var(--text); background:var(--bg3); }
.nav-item.active { color:var(--gold); background:var(--gold-dim); border-left-color:var(--gold); }
.nav-item i { width:18px; height:18px; }
.sidebar-footer { margin-top:auto; padding:16px 20px; border-top:1px solid var(--line); }
.sidebar-footer a { font-size:12px; color:var(--text3); text-decoration:none; display:flex; align-items:center; gap:8px; }
.sidebar-footer a:hover { color:var(--text); }

/* MAIN */
.main { margin-left:220px; flex:1; padding:24px 32px; min-height:100vh; }
.page-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:28px; }
.page-title { font-size:22px; font-weight:700; }
.page-subtitle { font-size:13px; color:var(--text3); margin-top:4px; }

/* CARDS */
.stat-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:24px; }
.stat-card { background:var(--bg2); border:1px solid var(--line); border-radius:var(--radius); padding:20px; }
.stat-label { font-size:12px; color:var(--text3); margin-bottom:8px; display:flex; align-items:center; gap:6px; }
.stat-label i { width:14px; height:14px; }
.stat-value { font-family:'Outfit'; font-size:28px; font-weight:800; }
.stat-sub { font-size:11px; color:var(--text3); margin-top:4px; }
.stat-up { color:var(--green); }
.stat-down { color:var(--red); }

/* TABLE */
.table-wrap { background:var(--bg2); border:1px solid var(--line); border-radius:var(--radius); overflow:hidden; margin-bottom:24px; }
.table-header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid var(--line); }
.table-title { font-size:15px; font-weight:600; }
.table-actions { display:flex; gap:8px; }
.search-box { background:var(--bg3); border:1px solid var(--line); border-radius:6px; padding:7px 12px; color:var(--text); font-size:13px; font-family:inherit; width:220px; }
.search-box::placeholder { color:var(--text3); }
.search-box:focus { outline:none; border-color:var(--gold); }
table { width:100%; border-collapse:collapse; }
th { text-align:left; font-size:11px; font-weight:600; color:var(--text3); text-transform:uppercase; letter-spacing:1px; padding:12px 16px; border-bottom:1px solid var(--line); }
td { padding:12px 16px; font-size:13px; border-bottom:1px solid var(--line); }
tr:hover td { background:var(--bg3); }
tr:last-child td { border-bottom:none; }

/* BADGES */
.badge { padding:3px 10px; border-radius:100px; font-size:11px; font-weight:600; }
.badge-pro { background:rgba(245,166,35,.15); color:var(--gold); }
.badge-free { background:rgba(100,100,140,.15); color:var(--text3); }
.badge-paid { background:rgba(34,197,94,.15); color:var(--green); }
.badge-refund { background:rgba(239,68,68,.15); color:var(--red); }
.badge-open { background:rgba(59,130,246,.15); color:var(--blue); }
.badge-replied { background:rgba(34,197,94,.15); color:var(--green); }
.badge-closed { background:rgba(100,100,140,.15); color:var(--text3); }

/* BUTTONS */
.btn { padding:7px 14px; border-radius:6px; font-size:12px; font-weight:600; border:none; cursor:pointer; font-family:inherit; transition:all .15s; display:inline-flex; align-items:center; gap:6px; }
.btn i { width:14px; height:14px; }
.btn-gold { background:var(--gold); color:#fff; }
.btn-gold:hover { background:var(--gold2); }
.btn-outline { background:transparent; border:1px solid var(--line); color:var(--text2); }
.btn-outline:hover { border-color:var(--text2); color:var(--text); }
.btn-danger { background:rgba(239,68,68,.15); color:var(--red); }
.btn-danger:hover { background:rgba(239,68,68,.25); }
.btn-sm { padding:5px 10px; font-size:11px; }

/* TAB CONTENT */
.tab-content { display:none; }
.tab-content.active { display:block; }

/* MODAL */
.modal-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.6); z-index:1000; align-items:center; justify-content:center; }
.modal-overlay.show { display:flex; }
.modal { background:var(--bg2); border:1px solid var(--line); border-radius:var(--radius); padding:28px; width:420px; max-width:90vw; }
.modal h3 { font-size:18px; margin-bottom:20px; }
.modal label { display:block; font-size:13px; color:var(--text2); margin-bottom:6px; margin-top:14px; }
.modal input, .modal select, .modal textarea { width:100%; background:var(--bg3); border:1px solid var(--line); border-radius:6px; padding:9px 12px; color:var(--text); font-size:13px; font-family:inherit; }
.modal input:focus, .modal select:focus, .modal textarea:focus { outline:none; border-color:var(--gold); }
.modal-btns { display:flex; gap:8px; margin-top:20px; justify-content:flex-end; }

/* CHART placeholder */
.chart-placeholder { background:var(--bg2); border:1px solid var(--line); border-radius:var(--radius); padding:40px; text-align:center; color:var(--text3); font-size:13px; margin-bottom:24px; min-height:200px; display:flex; align-items:center; justify-content:center; }

/* FORM ROW */
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }

/* SECTION */
.section-title { font-size:15px; font-weight:600; margin-bottom:16px; margin-top:28px; display:flex; align-items:center; gap:8px; }
.section-title i { width:18px; height:18px; color:var(--gold); }

/* Loading */
.loading { text-align:center; padding:40px; color:var(--text3); font-size:13px; }

@media(max-width:768px) {
    .sidebar { width:60px; } .sidebar-logo-text, .nav-item span { display:none; }
    .main { margin-left:60px; padding:16px; } .stat-grid { grid-template-columns:1fr 1fr; }
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
    <div class="sidebar-logo">
        <svg width="28" height="28" viewBox="0 0 42 42"><circle cx="21" cy="21" r="19.5" fill="none" stroke="#f5a623" stroke-width="2.5"/><ellipse cx="18" cy="16" rx="1.3" ry="4.2" fill="#f5a623"/><ellipse cx="24" cy="16" rx="1.3" ry="4.2" fill="#f5a623"/></svg>
        <div class="sidebar-logo-text">Luna<span>Wave</span></div>
    </div>
    <div class="nav-item active" data-tab="dashboard"><i data-lucide="layout-dashboard"></i><span>대시보드</span></div>
    <div class="nav-item" data-tab="users"><i data-lucide="users"></i><span>유저 관리</span></div>
    <div class="nav-item" data-tab="luna"><i data-lucide="coins"></i><span>루나 현황</span></div>
    <div class="nav-item" data-tab="payments"><i data-lucide="credit-card"></i><span>결제 내역</span></div>
    <div class="nav-item" data-tab="marketing"><i data-lucide="megaphone"></i><span>마케팅</span></div>
    <div class="nav-item" data-tab="analytics"><i data-lucide="bar-chart-2"></i><span>분석</span></div>
    <div class="nav-item" data-tab="cs"><i data-lucide="headphones"></i><span>CS / 운영</span></div>
    <div class="nav-item" data-tab="security"><i data-lucide="shield"></i><span>보안</span></div>
    <div class="nav-item" data-tab="events"><i data-lucide="calendar-days"></i><span>이벤트</span></div>
    <div class="nav-item" data-tab="ai-config"><i data-lucide="cpu"></i><span>AI 설정</span></div>
    <div class="sidebar-footer">
        <a href="/"><i data-lucide="arrow-left"></i><span>사이트로 돌아가기</span></a>
    </div>
</aside>

<!-- MAIN CONTENT -->
<div class="main">

<!-- ==================== TAB 1: 대시보드 ==================== -->
<div class="tab-content active" id="tab-dashboard">
    <div class="page-header">
        <div><div class="page-title">매출 대시보드</div><div class="page-subtitle">실시간 매출 및 핵심 지표</div></div>
        <button class="btn btn-outline" onclick="loadDashboardData()"><i data-lucide="refresh-cw"></i> 새로고침</button>
    </div>
    <div class="stat-grid">
        <div class="stat-card"><div class="stat-label"><i data-lucide="won-sign"></i>오늘 매출</div><div class="stat-value" id="d-today">₩0</div></div>
        <div class="stat-card"><div class="stat-label"><i data-lucide="trending-up"></i>이번 달 매출</div><div class="stat-value" id="d-month">₩0</div></div>
        <div class="stat-card"><div class="stat-label"><i data-lucide="users"></i>총 유저</div><div class="stat-value" id="d-users">0</div></div>
        <div class="stat-card"><div class="stat-label"><i data-lucide="crown"></i>활성 구독자</div><div class="stat-value" id="d-subs">0</div></div>
    </div>
    <div class="stat-grid">
        <div class="stat-card"><div class="stat-label">MRR (월간 반복매출)</div><div class="stat-value" id="d-mrr">₩0</div></div>
        <div class="stat-card"><div class="stat-label">구독 이탈률</div><div class="stat-value" id="d-churn">0%</div></div>
        <div class="stat-card"><div class="stat-label">ARPU</div><div class="stat-value" id="d-arpu">₩0</div></div>
        <div class="stat-card"><div class="stat-label">오늘 가입</div><div class="stat-value" id="d-new">0</div></div>
    </div>
    <div class="chart-placeholder">매출 차트 (데이터 수집 후 표시)</div>
</div>

<!-- ==================== TAB 2: 유저 관리 ==================== -->
<div class="tab-content" id="tab-users">
    <div class="page-header">
        <div><div class="page-title">유저 관리</div><div class="page-subtitle">전체 회원 목록 및 관리</div></div>
    </div>
    <div class="table-wrap">
        <div class="table-header">
            <div class="table-title">유저 목록</div>
            <div class="table-actions">
                <input type="text" class="search-box" id="userSearch" placeholder="이메일 또는 이름 검색...">
            </div>
        </div>
        <table>
            <thead><tr><th>이메일</th><th>이름</th><th>플랜</th><th>루나 잔액</th><th>가입일</th><th>액션</th></tr></thead>
            <tbody id="userTableBody"><tr><td colspan="6" class="loading">로딩 중...</td></tr></tbody>
        </table>
    </div>
</div>

<!-- ==================== TAB 3: 루나 현황 ==================== -->
<div class="tab-content" id="tab-luna">
    <div class="page-header">
        <div><div class="page-title">루나 현황</div><div class="page-subtitle">전체 루나 발행 및 사용 현황</div></div>
    </div>
    <div class="stat-grid">
        <div class="stat-card"><div class="stat-label"><i data-lucide="coins"></i>총 발행 루나</div><div class="stat-value" id="l-issued">0</div></div>
        <div class="stat-card"><div class="stat-label"><i data-lucide="flame"></i>총 사용 루나</div><div class="stat-value" id="l-used">0</div></div>
        <div class="stat-card"><div class="stat-label"><i data-lucide="wallet"></i>총 잔여 루나</div><div class="stat-value" id="l-remaining">0</div></div>
        <div class="stat-card"><div class="stat-label"><i data-lucide="alert-triangle"></i>이상 사용</div><div class="stat-value" id="l-anomaly">0</div></div>
    </div>
    <div class="section-title"><i data-lucide="pie-chart"></i> 기능별 사용 비율</div>
    <div class="chart-placeholder">기능별 루나 사용 비율 차트 (데이터 수집 후 표시)</div>
    <div class="section-title"><i data-lucide="list"></i> 최근 루나 사용 내역</div>
    <div class="table-wrap">
        <table>
            <thead><tr><th>유저</th><th>기능</th><th>소비량</th><th>잔액</th><th>시간</th></tr></thead>
            <tbody id="lunaLogBody"><tr><td colspan="5" class="loading">데이터 수집 중...</td></tr></tbody>
        </table>
    </div>
</div>

<!-- ==================== TAB 4: 결제 내역 ==================== -->
<div class="tab-content" id="tab-payments">
    <div class="page-header">
        <div><div class="page-title">결제 내역</div><div class="page-subtitle">전체 결제 및 환불 관리</div></div>
    </div>
    <div class="table-wrap">
        <div class="table-header">
            <div class="table-title">결제 목록</div>
            <div class="table-actions">
                <select class="search-box" id="payFilter" style="width:140px;">
                    <option value="all">전체</option>
                    <option value="paid">결제완료</option>
                    <option value="refunded">환불</option>
                </select>
                <input type="text" class="search-box" id="paySearch" placeholder="이메일 검색...">
            </div>
        </div>
        <table>
            <thead><tr><th>날짜</th><th>유저</th><th>유형</th><th>금액</th><th>상태</th><th>액션</th></tr></thead>
            <tbody id="payTableBody"><tr><td colspan="6" class="loading">로딩 중...</td></tr></tbody>
        </table>
    </div>
</div>

<!-- ==================== TAB 5: 마케팅 ==================== -->
<div class="tab-content" id="tab-marketing">
    <div class="page-header">
        <div><div class="page-title">마케팅</div><div class="page-subtitle">추천인, 프로모션 코드, 할인 관리</div></div>
    </div>

    <div class="section-title"><i data-lucide="gift"></i> 추천인 시스템</div>
    <div class="stat-grid" style="grid-template-columns:repeat(3,1fr);">
        <div class="stat-card"><div class="stat-label">총 추천 수</div><div class="stat-value" id="m-refs">0</div></div>
        <div class="stat-card"><div class="stat-label">전환 수 (Pro 결제)</div><div class="stat-value" id="m-conv">0</div></div>
        <div class="stat-card"><div class="stat-label">지급 보너스 루나</div><div class="stat-value" id="m-bonus">0</div></div>
    </div>

    <div class="section-title"><i data-lucide="tag"></i> 프로모션 코드</div>
    <div class="table-wrap">
        <div class="table-header">
            <div class="table-title">코드 목록</div>
            <button class="btn btn-gold" onclick="showPromoModal()"><i data-lucide="plus"></i> 코드 생성</button>
        </div>
        <table>
            <thead><tr><th>코드</th><th>유형</th><th>값</th><th>사용/최대</th><th>만료일</th><th>상태</th></tr></thead>
            <tbody id="promoTableBody"><tr><td colspan="6" class="loading">로딩 중...</td></tr></tbody>
        </table>
    </div>

    <div class="section-title"><i data-lucide="percent"></i> 첫 결제 할인</div>
    <div class="stat-card" style="display:flex;align-items:center;justify-content:space-between;background:var(--bg2);border:1px solid var(--line);border-radius:var(--radius);padding:20px;">
        <div>
            <div style="font-size:15px;font-weight:600;">첫 달 할인율</div>
            <div style="font-size:13px;color:var(--text3);margin-top:4px;">현재: 30% (₩12,530)</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
            <input type="number" id="discountRate" value="30" min="0" max="80" style="width:80px;background:var(--bg3);border:1px solid var(--line);border-radius:6px;padding:8px;color:var(--text);font-size:15px;font-weight:700;text-align:center;">
            <span style="color:var(--text2);">%</span>
            <button class="btn btn-gold" onclick="saveDiscount()">저장</button>
        </div>
    </div>
</div>

<!-- ==================== TAB 6: 분석 ==================== -->
<div class="tab-content" id="tab-analytics">
    <div class="page-header">
        <div><div class="page-title">유저 분석</div><div class="page-subtitle">전환율, 이탈 경고, 활성 유저</div></div>
    </div>
    <div class="stat-grid">
        <div class="stat-card"><div class="stat-label">DAU (일간 활성)</div><div class="stat-value" id="a-dau">0</div></div>
        <div class="stat-card"><div class="stat-label">WAU (주간 활성)</div><div class="stat-value" id="a-wau">0</div></div>
        <div class="stat-card"><div class="stat-label">MAU (월간 활성)</div><div class="stat-value" id="a-mau">0</div></div>
        <div class="stat-card"><div class="stat-label">Free→Pro 전환율</div><div class="stat-value" id="a-conv">0%</div></div>
    </div>
    <div class="section-title"><i data-lucide="funnel"></i> 전환 퍼널</div>
    <div class="chart-placeholder">가입 → 앱 다운로드 → 첫 실행 → Free 3곡 소진 → Pro 결제 (데이터 수집 후 표시)</div>
    <div class="section-title"><i data-lucide="alert-circle"></i> 이탈 경고 (7일 이상 미접속)</div>
    <div class="table-wrap">
        <table>
            <thead><tr><th>이메일</th><th>플랜</th><th>마지막 접속</th><th>미접속 일수</th><th>액션</th></tr></thead>
            <tbody id="churnTableBody"><tr><td colspan="5" class="loading">데이터 수집 중...</td></tr></tbody>
        </table>
    </div>
</div>

<!-- ==================== TAB 7: CS / 운영 ==================== -->
<div class="tab-content" id="tab-cs">
    <div class="page-header">
        <div><div class="page-title">CS / 운영</div><div class="page-subtitle">문의, 공지사항, 버전 관리</div></div>
    </div>

    <div class="section-title"><i data-lucide="message-circle"></i> 1:1 문의</div>
    <div class="table-wrap">
        <div class="table-header">
            <div class="table-title">문의 목록</div>
            <select class="search-box" id="csFilter" style="width:120px;">
                <option value="all">전체</option>
                <option value="open">대기중</option>
                <option value="replied">답변완료</option>
            </select>
        </div>
        <table>
            <thead><tr><th>유저</th><th>제목</th><th>상태</th><th>날짜</th><th>액션</th></tr></thead>
            <tbody id="csTableBody"><tr><td colspan="5" class="loading">문의 없음</td></tr></tbody>
        </table>
    </div>

    <div class="section-title"><i data-lucide="bell"></i> 공지사항</div>
    <div class="table-wrap">
        <div class="table-header">
            <div class="table-title">공지 목록</div>
            <button class="btn btn-gold" onclick="showNoticeModal()"><i data-lucide="plus"></i> 공지 작성</button>
        </div>
        <table>
            <thead><tr><th>제목</th><th>유형</th><th>고정</th><th>기간</th><th>상태</th><th>날짜</th><th>액션</th></tr></thead>
            <tbody id="noticeTableBody"><tr><td colspan="7" class="loading">로딩 중...</td></tr></tbody>
        </table>
    </div>

    <div class="section-title"><i data-lucide="download"></i> 앱 버전 관리</div>
    <div class="stat-card" style="display:flex;align-items:center;justify-content:space-between;background:var(--bg2);border:1px solid var(--line);border-radius:var(--radius);padding:20px;">
        <div>
            <div style="font-size:15px;font-weight:600;">현재 최신 버전</div>
            <div style="font-size:13px;color:var(--text3);margin-top:4px;">최소 지원: v5.0.0-beta.1</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
            <input type="text" id="appVersion" value="5.0.0-beta.1" style="width:100px;background:var(--bg3);border:1px solid var(--line);border-radius:6px;padding:8px;color:var(--text);font-size:14px;text-align:center;">
            <button class="btn btn-gold" onclick="saveVersion()">저장</button>
        </div>
    </div>
</div>

<!-- ==================== TAB 8: 보안 ==================== -->
<div class="tab-content" id="tab-security">
    <div class="page-header">
        <div><div class="page-title">보안 / 감시</div><div class="page-subtitle">이상 사용 감지, 로그인 기록, API 모니터링</div></div>
    </div>

    <div class="section-title"><i data-lucide="alert-triangle"></i> 이상 사용 감지</div>
    <div class="table-wrap">
        <table>
            <thead><tr><th>유저</th><th>유형</th><th>내용</th><th>시간</th><th>액션</th></tr></thead>
            <tbody id="secAlertBody">
                <tr><td colspan="5" class="loading">이상 감지 없음</td></tr>
            </tbody>
        </table>
    </div>

    <div class="section-title"><i data-lucide="log-in"></i> 최근 로그인 기록</div>
    <div class="table-wrap">
        <table>
            <thead><tr><th>유저</th><th>IP</th><th>기기</th><th>시간</th></tr></thead>
            <tbody id="loginLogBody"><tr><td colspan="4" class="loading">데이터 수집 중...</td></tr></tbody>
        </table>
    </div>

    <div class="section-title"><i data-lucide="monitor"></i> Free 악용 현황</div>
    <div class="table-wrap">
        <table>
            <thead><tr><th>기기 ID</th><th>연결 계정 수</th><th>계정 목록</th><th>상태</th></tr></thead>
            <tbody id="freeAbuseBody"><tr><td colspan="4" class="loading">데이터 수집 중...</td></tr></tbody>
        </table>
    </div>
</div>

<!-- ==================== TAB 9: 이벤트 ==================== -->
<div class="tab-content" id="tab-events">
    <div class="page-header">
        <div><div class="page-title">이벤트 관리</div><div class="page-subtitle">이벤트 생성 및 루나 자동 지급 관리</div></div>
        <button class="btn btn-gold" onclick="showEventModal()"><i data-lucide="plus"></i> 새 이벤트</button>
    </div>
    <div class="table-wrap">
        <div class="table-header">
            <div class="table-title">이벤트 목록</div>
        </div>
        <table>
            <thead><tr><th>제목</th><th>유형</th><th>일일 지급</th><th>기간</th><th>대상</th><th>상태</th><th>액션</th></tr></thead>
            <tbody id="eventTableBody"><tr><td colspan="7" class="loading">로딩 중...</td></tr></tbody>
        </table>
    </div>
</div>

<!-- ==================== TAB 10: AI 설정 ==================== -->
<div class="tab-content" id="tab-ai-config">
    <div class="page-header">
        <div><div class="page-title">AI API 키 관리</div><div class="page-subtitle">AI 프로바이더 선택 및 API 키 관리</div></div>
    </div>

    <div class="section-title"><i data-lucide="zap"></i> 메인 AI 프로바이더</div>
    <div class="stat-card" style="background:var(--bg2);border:1px solid var(--line);border-radius:var(--radius);padding:20px;margin-bottom:24px;">
        <div style="display:flex;gap:24px;align-items:center;flex-wrap:wrap;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:14px;">
                <input type="radio" name="aiProvider" value="openai" checked> OpenAI (GPT)
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:14px;">
                <input type="radio" name="aiProvider" value="claude"> Claude (Anthropic)
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:14px;">
                <input type="radio" name="aiProvider" value="gemini"> Gemini (Google)
            </label>
            <button class="btn btn-gold" onclick="changeActiveProvider()">메인 AI 변경</button>
        </div>
        <div style="margin-top:12px;font-size:12px;color:var(--text3);" id="aiStatusLine">현재 활성 AI: -</div>
    </div>

    <div class="section-title"><i data-lucide="key"></i> API 키 설정</div>
    <div style="display:grid;gap:16px;">
        <div class="stat-card" style="display:flex;align-items:center;justify-content:space-between;background:var(--bg2);border:1px solid var(--line);border-radius:var(--radius);padding:16px;">
            <div style="flex:1;">
                <div style="font-size:13px;font-weight:600;margin-bottom:8px;">OpenAI API Key</div>
                <input type="password" id="openaiKeyInput" placeholder="sk-..." style="width:100%;background:var(--bg3);border:1px solid var(--line);border-radius:6px;padding:8px 12px;color:var(--text);font-size:13px;">
            </div>
            <div style="display:flex;gap:8px;margin-left:12px;">
                <button class="btn btn-sm btn-outline" onclick="toggleKeyVis('openaiKeyInput')">표시</button>
                <button class="btn btn-sm btn-gold" onclick="saveAiKey('openai')">저장</button>
            </div>
        </div>
        <div class="stat-card" style="display:flex;align-items:center;justify-content:space-between;background:var(--bg2);border:1px solid var(--line);border-radius:var(--radius);padding:16px;">
            <div style="flex:1;">
                <div style="font-size:13px;font-weight:600;margin-bottom:8px;">Claude API Key</div>
                <input type="password" id="claudeKeyInput" placeholder="sk-ant-..." style="width:100%;background:var(--bg3);border:1px solid var(--line);border-radius:6px;padding:8px 12px;color:var(--text);font-size:13px;">
            </div>
            <div style="display:flex;gap:8px;margin-left:12px;">
                <button class="btn btn-sm btn-outline" onclick="toggleKeyVis('claudeKeyInput')">표시</button>
                <button class="btn btn-sm btn-gold" onclick="saveAiKey('claude')">저장</button>
            </div>
        </div>
        <div class="stat-card" style="display:flex;align-items:center;justify-content:space-between;background:var(--bg2);border:1px solid var(--line);border-radius:var(--radius);padding:16px;">
            <div style="flex:1;">
                <div style="font-size:13px;font-weight:600;margin-bottom:8px;">Gemini API Key</div>
                <input type="password" id="geminiKeyInput" placeholder="AIza..." style="width:100%;background:var(--bg3);border:1px solid var(--line);border-radius:6px;padding:8px 12px;color:var(--text);font-size:13px;">
            </div>
            <div style="display:flex;gap:8px;margin-left:12px;">
                <button class="btn btn-sm btn-outline" onclick="toggleKeyVis('geminiKeyInput')">표시</button>
                <button class="btn btn-sm btn-gold" onclick="saveAiKey('gemini')">저장</button>
            </div>
        </div>
    </div>

    <div style="margin-top:20px;padding:16px;background:var(--bg2);border:1px solid var(--line);border-radius:var(--radius);">
        <div style="font-size:12px;color:var(--text3);" id="aiLastUpdate">마지막 변경: -</div>
    </div>
</div>

</div><!-- /main -->

<!-- ==================== MODALS ==================== -->

<!-- 루나 지급/차감 모달 -->
<div class="modal-overlay" id="lunaModal">
    <div class="modal">
        <h3>루나 수동 관리</h3>
        <label>유저</label>
        <input type="text" id="lunaModalUser" readonly>
        <div class="form-row">
            <div><label>유형</label><select id="lunaModalType"><option value="grant">지급</option><option value="deduct">차감</option></select></div>
            <div><label>수량</label><input type="number" id="lunaModalAmount" value="100" min="1"></div>
        </div>
        <label>사유</label>
        <input type="text" id="lunaModalReason" placeholder="CS 보상, 이벤트 등">
        <div class="modal-btns">
            <button class="btn btn-outline" onclick="closeLunaModal()">취소</button>
            <button class="btn btn-gold" onclick="submitLunaAction()">확인</button>
        </div>
    </div>
</div>

<!-- 프로모션 코드 생성 모달 -->
<div class="modal-overlay" id="promoModal">
    <div class="modal">
        <h3>프로모션 코드 생성</h3>
        <label>코드</label>
        <input type="text" id="promoCode" placeholder="예: LAUNCH30" style="text-transform:uppercase;">
        <div class="form-row">
            <div><label>유형</label><select id="promoType"><option value="discount">할인(%)</option><option value="tokens">루나 보너스</option></select></div>
            <div><label>값</label><input type="number" id="promoValue" value="30" min="1"></div>
        </div>
        <div class="form-row">
            <div><label>최대 사용 횟수</label><input type="number" id="promoMax" value="100" min="1"></div>
            <div><label>만료일</label><input type="date" id="promoExpiry"></div>
        </div>
        <div class="modal-btns">
            <button class="btn btn-outline" onclick="closePromoModal()">취소</button>
            <button class="btn btn-gold" onclick="submitPromo()">생성</button>
        </div>
    </div>
</div>

<!-- 공지사항 모달 -->
<div class="modal-overlay" id="noticeModal">
    <div class="modal">
        <h3>공지사항 작성</h3>
        <label>제목</label>
        <input type="text" id="noticeTitle" placeholder="공지 제목">
        <label>내용</label>
        <textarea id="noticeContent" rows="4" placeholder="공지 내용"></textarea>
        <div class="form-row">
            <div><label>유형</label>
                <select id="noticeType">
                    <option value="info">일반</option><option value="warning">경고</option><option value="urgent">긴급</option>
                    <option value="update">업데이트</option><option value="event">이벤트</option><option value="maintenance">점검</option>
                </select>
            </div>
            <div><label>외부 링크</label><input type="text" id="noticeUrl" placeholder="https://..."></div>
        </div>
        <div class="form-row">
            <div><label>시작일</label><input type="date" id="noticeStartDate"></div>
            <div><label>종료일</label><input type="date" id="noticeEndDate"></div>
        </div>
        <label style="display:flex;align-items:center;gap:8px;margin-top:14px;cursor:pointer;">
            <input type="checkbox" id="noticePinned"> 상단 고정 (Pinned)
        </label>
        <div class="modal-btns">
            <button class="btn btn-outline" onclick="closeNoticeModal()">취소</button>
            <button class="btn btn-gold" onclick="submitNotice()">등록</button>
        </div>
    </div>
</div>

<!-- 이벤트 모달 -->
<div class="modal-overlay" id="eventModal">
    <div class="modal">
        <h3 id="eventModalTitle">새 이벤트</h3>
        <label>제목</label>
        <input type="text" id="eventTitle" placeholder="이벤트 제목">
        <label>설명</label>
        <textarea id="eventDesc" rows="3" placeholder="이벤트 설명"></textarea>
        <div class="form-row">
            <div><label>유형</label><select id="eventType"><option value="daily_luna">일일 루나 지급</option></select></div>
            <div><label>일일 지급량</label><input type="number" id="eventAmount" value="50" min="1"></div>
        </div>
        <div class="form-row">
            <div><label>시작일</label><input type="date" id="eventStart"></div>
            <div><label>종료일</label><input type="date" id="eventEnd"></div>
        </div>
        <label>대상</label>
        <select id="eventTarget"><option value="all">전체</option><option value="pro">Pro 유저</option><option value="free">Free 유저</option></select>
        <div class="modal-btns">
            <button class="btn btn-outline" onclick="closeEventModal()">취소</button>
            <button class="btn btn-gold" onclick="saveEvent()">저장</button>
        </div>
    </div>
</div>

<!-- 환불 모달 -->
<div class="modal-overlay" id="refundModal">
    <div class="modal">
        <h3>환불 처리</h3>
        <label>결제 정보</label>
        <input type="text" id="refundInfo" readonly>
        <label>환불 금액</label>
        <input type="number" id="refundAmount" min="0">
        <label>환불 사유</label>
        <input type="text" id="refundReason" placeholder="환불 사유 입력">
        <div class="modal-btns">
            <button class="btn btn-outline" onclick="closeRefundModal()">취소</button>
            <button class="btn btn-danger" onclick="submitRefund()">환불 처리</button>
        </div>
    </div>
</div>

<script>
lucide.createIcons();

const _realSb = LW.supabase;

// ========== ADMIN PROXY (service_role via Netlify Function) ==========
class _AdminQuery {
    constructor(table) {
        this._t = table; this._action = 'select'; this._sel = '*'; this._selOpts = {};
        this._data = null; this._filters = []; this._orders = []; this._limit = null;
        this._single = false; this._range = null;
    }
    select(c, o) { this._sel = c || '*'; this._selOpts = o || {}; return this; }
    insert(d) { this._action = 'insert'; this._data = d; return this; }
    update(d) { this._action = 'update'; this._data = d; return this; }
    delete() { this._action = 'delete'; return this; }
    eq(c, v) { this._filters.push({op:'eq',col:c,val:v}); return this; }
    neq(c, v) { this._filters.push({op:'neq',col:c,val:v}); return this; }
    gte(c, v) { this._filters.push({op:'gte',col:c,val:v}); return this; }
    lte(c, v) { this._filters.push({op:'lte',col:c,val:v}); return this; }
    gt(c, v) { this._filters.push({op:'gt',col:c,val:v}); return this; }
    lt(c, v) { this._filters.push({op:'lt',col:c,val:v}); return this; }
    in(c, v) { this._filters.push({op:'in',col:c,val:v}); return this; }
    is(c, v) { this._filters.push({op:'is',col:c,val:v}); return this; }
    not(c, op, v) { this._filters.push({op:'not',col:c,innerOp:op,val:v}); return this; }
    order(c, o) { this._orders.push({column:c,...(o||{})}); return this; }
    limit(n) { this._limit = n; return this; }
    range(f, t) { this._range = [f, t]; return this; }
    single() { this._single = true; return this; }
    then(resolve, reject) { return this._exec().then(resolve, reject); }
    async _exec() {
        try {
            const { data: { session } } = await _realSb.auth.getSession();
            if (!session) return { data: null, error: { message: 'No session' }, count: null };
            const res = await fetch('/api/admin-db', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + session.access_token },
                body: JSON.stringify({
                    table: this._t, action: this._action, data: this._data,
                    select: this._sel, selectOpts: this._selOpts, filters: this._filters,
                    order: this._orders.length ? this._orders : undefined,
                    limit: this._limit, single: this._single, range: this._range
                })
            });
            return await res.json();
        } catch (e) { return { data: null, error: { message: e.message }, count: null }; }
    }
}
const sb = { from: (t) => new _AdminQuery(t), auth: _realSb.auth };

// ========== TAB NAVIGATION ==========
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        item.classList.add('active');
        document.getElementById('tab-' + item.dataset.tab).classList.add('active');
        lucide.createIcons();
    });
});

// ========== AUTH CHECK ==========
async function checkAdmin() {
    const { data: { user } } = await _realSb.auth.getUser();
    if (!user) { window.location.href = '/login.html'; return; }
    const { data: profile } = await sb.from('profiles').select('role').eq('id', user.id).single();
    if (!profile || profile.role !== 'admin') {
        alert('관리자 권한이 없습니다.');
        window.location.href = '/dashboard.html';
        return;
    }
    loadAllData();
}

// ========== LOAD ALL DATA ==========
async function loadAllData() {
    loadDashboardData();
    loadUsers();
    loadPayments();
    loadPromos();
    loadNotices();
    loadEvents();
    loadAiConfig();
}

// ========== DASHBOARD ==========
async function loadDashboardData() {
    try {
        // Total users
        const { count: totalUsers } = await sb.from('profiles').select('*', { count: 'exact', head: true });
        document.getElementById('d-users').textContent = totalUsers || 0;

        // Pro subscribers
        const { count: proUsers } = await sb.from('profiles').select('*', { count: 'exact', head: true }).eq('plan', 'pro');
        document.getElementById('d-subs').textContent = proUsers || 0;

        // MRR
        const mrr = (proUsers || 0) * 17900;
        document.getElementById('d-mrr').textContent = '₩' + mrr.toLocaleString();

        // Today signups
        const today = new Date().toISOString().split('T')[0];
        const { count: newToday } = await sb.from('profiles').select('*', { count: 'exact', head: true }).gte('created_at', today);
        document.getElementById('d-new').textContent = newToday || 0;

        // Payments this month
        const monthStart = new Date().toISOString().slice(0, 7) + '-01';
        const { data: monthPay } = await sb.from('payments').select('amount').eq('status', 'paid').gte('paid_at', monthStart);
        const monthTotal = (monthPay || []).reduce((s, p) => s + (p.amount || 0), 0);
        document.getElementById('d-month').textContent = '₩' + monthTotal.toLocaleString();

        // Today payments
        const { data: todayPay } = await sb.from('payments').select('amount').eq('status', 'paid').gte('paid_at', today);
        const todayTotal = (todayPay || []).reduce((s, p) => s + (p.amount || 0), 0);
        document.getElementById('d-today').textContent = '₩' + todayTotal.toLocaleString();

        // ARPU
        const arpu = totalUsers ? Math.round(monthTotal / totalUsers) : 0;
        document.getElementById('d-arpu').textContent = '₩' + arpu.toLocaleString();

    } catch (e) { console.error('Dashboard error:', e); }
}

// ========== USERS ==========
async function loadUsers() {
    try {
        const { data: users } = await sb.from('profiles').select('*').order('created_at', { ascending: false });
        renderUsers(users || []);
    } catch (e) { console.error('Users error:', e); }
}

function renderUsers(users) {
    const tbody = document.getElementById('userTableBody');
    if (!users.length) { tbody.innerHTML = '<tr><td colspan="6" class="loading">등록된 유저 없음</td></tr>'; return; }
    tbody.innerHTML = users.map(u => `
        <tr>
            <td>${u.email || '-'}</td>
            <td>${u.name || '-'}</td>
            <td><span class="badge badge-${u.plan === 'pro' ? 'pro' : 'free'}">${u.plan === 'pro' ? 'Pro' : 'Free'}</span></td>
            <td>${(u.lunas_free || 0) + (u.lunas_monthly || 0) + (u.lunas_bonus || 0) + (u.tokens_purchased || 0)}</td>
            <td>${u.created_at ? new Date(u.created_at).toLocaleDateString() : '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline" onclick="showLunaModal('${u.id}','${u.email}')">루나 관리</button>
                <button class="btn btn-sm btn-danger" onclick="toggleBan('${u.id}', ${u.is_banned || false})">${u.is_banned ? '해제' : '차단'}</button>
            </td>
        </tr>
    `).join('');
}

// User search
document.getElementById('userSearch').addEventListener('input', async (e) => {
    const q = e.target.value.toLowerCase();
    const { data: users } = await sb.from('profiles').select('*').order('created_at', { ascending: false });
    const filtered = (users || []).filter(u => (u.email || '').toLowerCase().includes(q) || (u.name || '').toLowerCase().includes(q));
    renderUsers(filtered);
});

// ========== LUNA MODAL ==========
let lunaTargetUser = null;
function showLunaModal(userId, email) {
    lunaTargetUser = userId;
    document.getElementById('lunaModalUser').value = email;
    document.getElementById('lunaModal').classList.add('show');
}
function closeLunaModal() { document.getElementById('lunaModal').classList.remove('show'); }
async function submitLunaAction() {
    const type = document.getElementById('lunaModalType').value;
    const amount = parseInt(document.getElementById('lunaModalAmount').value);
    const reason = document.getElementById('lunaModalReason').value;
    if (!amount || amount <= 0) { alert('수량을 입력하세요'); return; }

    const field = 'tokens_purchased';
    const { data: profile } = await sb.from('profiles').select(field).eq('id', lunaTargetUser).single();
    const current = profile?.[field] || 0;
    const newVal = type === 'grant' ? current + amount : Math.max(0, current - amount);

    await sb.from('profiles').update({ [field]: newVal }).eq('id', lunaTargetUser);
    alert(`${type === 'grant' ? '지급' : '차감'} 완료: ${amount} 루나 (${reason})`);
    closeLunaModal();
    loadUsers();
}

// ========== BAN ==========
async function toggleBan(userId, isBanned) {
    const action = isBanned ? '차단 해제' : '차단';
    if (!confirm(`이 유저를 ${action}하시겠습니까?`)) return;
    await sb.from('profiles').update({ is_banned: !isBanned }).eq('id', userId);
    loadUsers();
}

// ========== PAYMENTS ==========
async function loadPayments() {
    try {
        let { data: payments, error } = await sb.from('payments').select('*, profiles(email)').order('created_at', { ascending: false }).limit(50);
        if (error || !payments) {
            // Fallback: load without join, then manually add emails
            const r = await sb.from('payments').select('*').order('created_at', { ascending: false }).limit(50);
            payments = r.data || [];
            const uids = [...new Set(payments.map(p => p.user_id).filter(Boolean))];
            if (uids.length) {
                const { data: users } = await sb.from('profiles').select('id, email').in('id', uids);
                const m = {}; (users || []).forEach(u => m[u.id] = u.email);
                payments.forEach(p => p.profiles = { email: m[p.user_id] || '-' });
            }
        }
        renderPayments(payments || []);
    } catch (e) { console.error('Payments error:', e); }
}

function renderPayments(payments) {
    const tbody = document.getElementById('payTableBody');
    if (!payments.length) { tbody.innerHTML = '<tr><td colspan="6" class="loading">결제 내역 없음</td></tr>'; return; }
    tbody.innerHTML = payments.map(p => `
        <tr>
            <td>${p.paid_at ? new Date(p.paid_at).toLocaleDateString() : new Date(p.created_at).toLocaleDateString()}</td>
            <td>${p.profiles?.email || '-'}</td>
            <td>${p.type === 'subscription' ? 'Pro 구독' : '루나 구매'}</td>
            <td>₩${(p.amount || 0).toLocaleString()}</td>
            <td><span class="badge badge-${p.status === 'paid' ? 'paid' : 'refund'}">${p.status === 'paid' ? '결제완료' : '환불'}</span></td>
            <td>${p.status === 'paid' ? `<button class="btn btn-sm btn-danger" onclick="showRefundModal('${p.id}','${p.profiles?.email}',${p.amount})">환불</button>` : '-'}</td>
        </tr>
    `).join('');
}

// ========== REFUND MODAL ==========
let refundTargetId = null;
function showRefundModal(payId, email, amount) {
    refundTargetId = payId;
    document.getElementById('refundInfo').value = `${email} - ₩${amount.toLocaleString()}`;
    document.getElementById('refundAmount').value = amount;
    document.getElementById('refundModal').classList.add('show');
}
function closeRefundModal() { document.getElementById('refundModal').classList.remove('show'); }
async function submitRefund() {
    const reason = document.getElementById('refundReason').value;
    if (!reason) { alert('환불 사유를 입력하세요'); return; }
    // 1. 결제 상태 변경
    const { data: pay } = await sb.from('payments').select('user_id, tokens_granted').eq('id', refundTargetId).single();
    await sb.from('payments').update({ status: 'refunded', refund_reason: reason }).eq('id', refundTargetId);
    // 2. 루나 회수 + plan free 전환
    if (pay && pay.user_id) {
        await sb.from('profiles').update({
            plan: 'free', billing_key: null,
            tokens_balance: 0, tokens_purchased: 0,
            lunas_monthly: 0,
            updated_at: new Date().toISOString()
        }).eq('id', pay.user_id);
        await sb.from('tokens_log').insert({
            user_id: pay.user_id, action: 'refund', amount: -(pay.tokens_granted || 0),
            description: '관리자 환불: ' + reason
        });
    }
    alert('환불 처리 완료 (루나 회수됨)');
    closeRefundModal();
    loadPayments();
    loadUsers();
    loadDashboardData();
}

// ========== PROMO ==========
async function loadPromos() {
    try {
        const { data: promos } = await sb.from('promo_codes').select('*').order('created_at', { ascending: false });
        renderPromos(promos || []);
    } catch (e) { console.error('Promos error:', e); }
}

function renderPromos(promos) {
    const tbody = document.getElementById('promoTableBody');
    if (!promos.length) { tbody.innerHTML = '<tr><td colspan="6" class="loading">프로모션 코드 없음</td></tr>'; return; }
    tbody.innerHTML = promos.map(p => `
        <tr>
            <td style="font-family:monospace;font-weight:600;">${p.code}</td>
            <td>${p.type === 'discount' ? '할인' : '루나 보너스'}</td>
            <td>${p.type === 'discount' ? p.value + '%' : p.value + ' 루나'}</td>
            <td>${p.used_count}/${p.max_uses}</td>
            <td>${p.expires_at ? new Date(p.expires_at).toLocaleDateString() : '무기한'}</td>
            <td><span class="badge ${p.is_active ? 'badge-paid' : 'badge-free'}">${p.is_active ? '활성' : '비활성'}</span></td>
        </tr>
    `).join('');
}

function showPromoModal() { document.getElementById('promoModal').classList.add('show'); }
function closePromoModal() { document.getElementById('promoModal').classList.remove('show'); }
async function submitPromo() {
    const code = document.getElementById('promoCode').value.toUpperCase().trim();
    const type = document.getElementById('promoType').value;
    const value = parseFloat(document.getElementById('promoValue').value);
    const max_uses = parseInt(document.getElementById('promoMax').value);
    const expiry = document.getElementById('promoExpiry').value;

    if (!code) { alert('코드를 입력하세요'); return; }

    await sb.from('promo_codes').insert({
        code, type, value, max_uses,
        expires_at: expiry || null,
        is_active: true
    });
    alert('프로모션 코드 생성 완료');
    closePromoModal();
    loadPromos();
}

// ========== NOTICES (보강) ==========
async function loadNotices() {
    try {
        const { data: notices } = await sb.from('notices').select('*')
            .order('is_pinned', { ascending: false })
            .order('created_at', { ascending: false });
        renderNotices(notices || []);
    } catch (e) { console.error('Notices error:', e); }
}

function renderNotices(notices) {
    const tbody = document.getElementById('noticeTableBody');
    if (!notices.length) { tbody.innerHTML = '<tr><td colspan="7" class="loading">공지 없음</td></tr>'; return; }
    const typeLabel = { info:'일반', warning:'경고', urgent:'긴급', update:'업데이트', event:'이벤트', maintenance:'점검' };
    tbody.innerHTML = notices.map(n => {
        const nType = n.notice_type || n.type || 'info';
        const period = (n.start_date || n.end_date) ? `${n.start_date || '~'} ~ ${n.end_date || '무기한'}` : '-';
        return `
        <tr>
            <td>${n.url ? '<a href="'+n.url+'" target="_blank" style="color:var(--gold);">'+n.title+'</a>' : n.title}</td>
            <td>${typeLabel[nType] || nType}</td>
            <td>${n.is_pinned ? '<span style="color:var(--gold);">고정</span>' : '-'}</td>
            <td style="font-size:12px;">${period}</td>
            <td><span class="badge ${n.is_active ? 'badge-paid' : 'badge-free'}">${n.is_active ? '활성' : '비활성'}</span></td>
            <td>${new Date(n.created_at).toLocaleDateString()}</td>
            <td>
                <button class="btn btn-sm btn-outline" onclick="toggleNotice('${n.id}', ${n.is_active})">${n.is_active ? '비활성화' : '활성화'}</button>
                <button class="btn btn-sm btn-danger" onclick="deleteNotice('${n.id}')">삭제</button>
            </td>
        </tr>
    `}).join('');
}

function showNoticeModal() {
    document.getElementById('noticeTitle').value = '';
    document.getElementById('noticeContent').value = '';
    document.getElementById('noticeType').value = 'info';
    document.getElementById('noticeUrl').value = '';
    document.getElementById('noticeStartDate').value = '';
    document.getElementById('noticeEndDate').value = '';
    document.getElementById('noticePinned').checked = false;
    document.getElementById('noticeModal').classList.add('show');
}
function closeNoticeModal() { document.getElementById('noticeModal').classList.remove('show'); }
async function submitNotice() {
    const title = document.getElementById('noticeTitle').value;
    const content = document.getElementById('noticeContent').value;
    const type = document.getElementById('noticeType').value;
    const url = document.getElementById('noticeUrl').value.trim();
    const startDate = document.getElementById('noticeStartDate').value;
    const endDate = document.getElementById('noticeEndDate').value;
    const pinned = document.getElementById('noticePinned').checked;
    if (!title || !content) { alert('제목과 내용을 입력하세요'); return; }
    await sb.from('notices').insert({
        title, content, type, is_active: true,
        notice_type: type,
        is_pinned: pinned,
        url: url || null,
        start_date: startDate || null,
        end_date: endDate || null
    });
    alert('공지사항 등록 완료');
    closeNoticeModal();
    loadNotices();
}

async function toggleNotice(id, isActive) {
    await sb.from('notices').update({ is_active: !isActive }).eq('id', id);
    loadNotices();
}

async function deleteNotice(id) {
    if (!confirm('삭제하시겠습니까?')) return;
    await sb.from('notices').delete().eq('id', id);
    loadNotices();
}

// ========== EVENTS ==========
let editingEventId = null;
async function loadEvents() {
    try {
        const { data: events } = await sb.from('events').select('*').order('created_at', { ascending: false });
        renderEvents(events || []);
    } catch (e) { console.error('Events error:', e); }
}

function renderEvents(events) {
    const tbody = document.getElementById('eventTableBody');
    if (!events.length) { tbody.innerHTML = '<tr><td colspan="7" class="loading">이벤트 없음</td></tr>'; return; }
    const targetLabel = { all:'전체', pro:'Pro', free:'Free' };
    tbody.innerHTML = events.map(ev => `
        <tr>
            <td>${ev.title}</td>
            <td>${ev.event_type === 'daily_luna' ? '일일 루나' : ev.event_type}</td>
            <td style="font-weight:700;color:var(--gold);">${ev.daily_amount} 루나</td>
            <td style="font-size:12px;">${ev.start_date} ~ ${ev.end_date}</td>
            <td>${targetLabel[ev.target] || ev.target}</td>
            <td><span class="badge ${ev.is_active ? 'badge-paid' : 'badge-free'}">${ev.is_active ? '활성' : '비활성'}</span></td>
            <td>
                <button class="btn btn-sm btn-outline" onclick="editEvent(${ev.id})">수정</button>
                <button class="btn btn-sm btn-outline" onclick="toggleEvent(${ev.id}, ${ev.is_active})">${ev.is_active ? 'OFF' : 'ON'}</button>
                <button class="btn btn-sm btn-danger" onclick="deleteEvent(${ev.id})">삭제</button>
            </td>
        </tr>
    `).join('');
}

function showEventModal() {
    editingEventId = null;
    document.getElementById('eventModalTitle').textContent = '새 이벤트';
    document.getElementById('eventTitle').value = '';
    document.getElementById('eventDesc').value = '';
    document.getElementById('eventType').value = 'daily_luna';
    document.getElementById('eventAmount').value = '50';
    document.getElementById('eventStart').value = new Date().toISOString().split('T')[0];
    document.getElementById('eventEnd').value = '';
    document.getElementById('eventTarget').value = 'all';
    document.getElementById('eventModal').classList.add('show');
}
function closeEventModal() { document.getElementById('eventModal').classList.remove('show'); }

async function editEvent(id) {
    const { data: ev } = await sb.from('events').select('*').eq('id', id).single();
    if (!ev) return;
    editingEventId = id;
    document.getElementById('eventModalTitle').textContent = '이벤트 수정';
    document.getElementById('eventTitle').value = ev.title || '';
    document.getElementById('eventDesc').value = ev.description || '';
    document.getElementById('eventType').value = ev.event_type || 'daily_luna';
    document.getElementById('eventAmount').value = ev.daily_amount || 50;
    document.getElementById('eventStart').value = ev.start_date || '';
    document.getElementById('eventEnd').value = ev.end_date || '';
    document.getElementById('eventTarget').value = ev.target || 'all';
    document.getElementById('eventModal').classList.add('show');
}

async function saveEvent() {
    const title = document.getElementById('eventTitle').value.trim();
    const description = document.getElementById('eventDesc').value.trim();
    const event_type = document.getElementById('eventType').value;
    const daily_amount = parseInt(document.getElementById('eventAmount').value) || 50;
    const start_date = document.getElementById('eventStart').value;
    const end_date = document.getElementById('eventEnd').value;
    const target = document.getElementById('eventTarget').value;
    if (!title) { alert('제목을 입력하세요'); return; }
    if (!start_date || !end_date) { alert('시작일과 종료일을 입력하세요'); return; }

    const eventData = { title, description, event_type, daily_amount, start_date, end_date, target, updated_at: new Date().toISOString() };

    if (editingEventId) {
        await sb.from('events').update(eventData).eq('id', editingEventId);
        alert('이벤트가 수정되었습니다.');
    } else {
        eventData.is_active = true;
        await sb.from('events').insert(eventData);
        alert('이벤트가 생성되었습니다.');
    }
    closeEventModal();
    loadEvents();
}

async function toggleEvent(id, isActive) {
    await sb.from('events').update({ is_active: !isActive, updated_at: new Date().toISOString() }).eq('id', id);
    loadEvents();
}

async function deleteEvent(id) {
    if (!confirm('이벤트를 삭제하시겠습니까?')) return;
    await sb.from('events').delete().eq('id', id);
    loadEvents();
}

// ========== AI CONFIG ==========
async function loadAiConfig() {
    try {
        const { data } = await sb.from('ai_config').select('*').eq('id', 1).single();
        if (data) {
            document.getElementById('openaiKeyInput').value = maskKey(data.openai_key);
            document.getElementById('claudeKeyInput').value = maskKey(data.claude_key);
            document.getElementById('geminiKeyInput').value = maskKey(data.gemini_key);
            const provRadio = document.querySelector('input[name="aiProvider"][value="' + data.active_provider + '"]');
            if (provRadio) provRadio.checked = true;
            document.getElementById('aiStatusLine').textContent = '현재 활성 AI: ' + (data.active_provider || 'openai').toUpperCase();
            document.getElementById('aiLastUpdate').textContent = '마지막 변경: ' + (data.updated_at ? new Date(data.updated_at).toLocaleString() : '-');
        }
    } catch (e) { console.error('AI Config error:', e); }
}

function maskKey(key) {
    if (!key || key.length < 8) return '';
    return key.substring(0, 4) + '****' + key.substring(key.length - 4);
}

function toggleKeyVis(inputId) {
    const inp = document.getElementById(inputId);
    inp.type = inp.type === 'password' ? 'text' : 'password';
}

async function saveAiKey(provider) {
    const inputMap = { openai: 'openaiKeyInput', claude: 'claudeKeyInput', gemini: 'geminiKeyInput' };
    const fieldMap = { openai: 'openai_key', claude: 'claude_key', gemini: 'gemini_key' };
    const newKey = document.getElementById(inputMap[provider]).value.trim();
    if (!newKey || newKey.includes('****')) {
        alert('새 키를 입력하세요 (마스킹된 값은 저장할 수 없습니다)');
        return;
    }
    const { error } = await sb.from('ai_config').update({
        [fieldMap[provider]]: newKey,
        updated_at: new Date().toISOString()
    }).eq('id', 1);
    if (error) { alert('저장 실패: ' + error.message); return; }
    alert(provider.toUpperCase() + ' API 키가 저장되었습니다.');
    loadAiConfig();
}

async function changeActiveProvider() {
    const selected = document.querySelector('input[name="aiProvider"]:checked').value;
    if (!confirm('메인 AI를 ' + selected.toUpperCase() + '(으)로 변경하시겠습니까?\n모든 앱에 즉시 반영됩니다.')) return;
    const { error } = await sb.from('ai_config').update({
        active_provider: selected,
        updated_at: new Date().toISOString()
    }).eq('id', 1);
    if (error) { alert('변경 실패: ' + error.message); return; }
    alert('메인 AI가 ' + selected.toUpperCase() + '(으)로 변경되었습니다.');
    loadAiConfig();
}

// ========== HELPERS ==========
function saveDiscount() { alert('할인율이 저장되었습니다. payment.html에 반영해주세요.'); }
function saveVersion() { alert('버전 정보가 저장되었습니다.'); }

// ========== INIT ==========
checkAdmin();
</script>
</body>
</html>
